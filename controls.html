<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<script src="hotkeys.js"></script>
	<script type="text/javascript">
	const mindcontrol = new BroadcastChannel('obs-lyrics');

	mindcontrol.onmessage = function (ev) {
		("#lyric-panel").html(ev.data);
		
	}

	var hotkeyLyricSwitch1Old = hotkeyLyricSwitch1;
	var hotkeyLyricSwitch2Old = hotkeyLyricSwitch2;

	var lyrics = [];
	var index = -1;

	function ingest(){
		words = $("#words").val().split("\n");
		//alert(lyrics.length);
		index = -1

		lyrics = [$("#title").val()];
		
		for(let x=0; x<words.length; x){
			if(words[x].startsWith("###")){
				lyrics.push(words[x].replace("###",""));
				x++;
			}else{
				lyrics.push(words[x] + "<br>" + words[x+1]);
				x+=2;
			}
		}
		$("#lindex").html(index + "/" + lyrics.length);
	}

	function save(){
		//console.log($("#slots").val());



		var lyr = $("#words").val();

		lyr = lyr.replace(/\n\n\s+/g,"\n");
		lyr = lyr.replace(/#/g, "");
		lyr = lyr.trim();
		
		
		var l2 = [];
		l2 = lyr.split("\n");
		var wds = [];
		lines = 0;
		for(var i=0; i <l2.length; i++){
			console.log(i);
			let item = l2[i];
			if(item.length > 40){
				//split into two

				//find the , or ; in the middle of the line
				var cpos = item.indexOf(",", (item.length/2)-3);
				var semipos = item.indexOf(";", (item.length/2)-3);
				var spos = item.indexOf(" ", (item.length/2)-3);
				
				var knife = item.length;
				if(semipos > 0 && semipos < item.length * 0.75){
					knife = semipos+1;
				}else if(cpos > 0 && cpos < item.lengthc * 0.75){
					knife = cpos+1;
				}else{
					knife = spos;
				}
				
				console.log(l2[i] + "/" + l2[i+1])
				wds.push(item.slice(0,knife));
				lines++;
				console.log(l2[i+1]);
				if(i + 1 < l2.length && (l2[i+1].match(/^\d/)) && (lines+1%2 == 0)){
					wds.push("###" + item.slice(knife,item.length));		 
				}
				else{
					//lines++;					
					wds.push(item.slice(knife,item.length));
				}

			}else{
				//otherwise keep as is
				lines++;
				console.log(lines % 2);
				if((i+1 < l2.length) && (l2[i+1].match(/^\d/)) &&  (lines%2 > 0)){
					wds.push("###" + item.slice(knife,item.length));
				}
				else if((i+1 == l2.length) && (lines%2 > 0)){
					wds.push("###" + item.slice(knife,item.length));
				}
				else
				{
					wds.push(item);
				}
			}
		}
	
		$("#words").val(wds.join("\n"));




		var s=$("#slots").val();
		
		localStorage.setItem($("#slots").val(), JSON.stringify({'title':$("#title").val(), 'lyrics':$("#words").val()}));

		loadSlots();
		$("#slots").val(s);
		ingest();

	}

	function load(){
		var x = $("#slots").val();
		var s = JSON.parse(localStorage.getItem(x));
		if(s){
				$("#title").val(s.title);
				$("#words").val(s.lyrics);
				ingest();
			}else{
				$("#title").val("");
				$("#words").val("");	
			}
	}

	function sendLyric(){
		if(index == -1){
			mindcontrol.postMessage({'action':'update_title','text': lyrics[0]});
			mindcontrol.postMessage({'action':'show'});
			index = 0;
			//index++;
			$("#lindex").html(index + "/" + lyrics.length);
			return;
		}

		if(index >= lyrics.length){
			//time to hide!
			mindcontrol.postMessage({'action':'hide'});
			return;
		}

		index++;
		mindcontrol.postMessage({'action':'update_title','text': lyrics[index]});
		$("#lindex").html(index + "/" + lyrics.length);
	}
	
	function sendLyricBack(){
		if(index > lyrics.length){
			index = lyrics.length;
			mindcontrol.postMessage({'action':'update_title','text': lyrics[index]});
			mindcontrol.postMessage({'action':'show'});
			$("#lindex").html(index + "/" + lyrics.length);
			return;
		}

		if(index <= -1){
			//time to hide!
			mindcontrol.postMessage({'action':'hide'});
			return;
		}

		index--;
		mindcontrol.postMessage({'action':'update_title','text': lyrics[index]});
		$("#lindex").html(index + "/" + lyrics.length);
	}

	function loadSlots(){
		//var opts = "";
		$("#slots").html("");
		for(let x = 1; x<11; x++){
			//console.dir(localStorage.getItem("Song" + x));
			var s = JSON.parse(localStorage.getItem("Song" + x));
			if(s){
				$("#slots").append(new Option(s.title, "Song"+x));
			}else{
				$("#slots").append(new Option(x + " - Empty", "Song"+x));
			}
			
		}
	}

	function clearStorage(){
		localStorage.clear();
	}


	</script>
		
		<title>Lyric Magic</title>
		<link rel="stylesheet" href="controls.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	</head>
	<body>
	<div class="input-group">
		<div id="slotselect">
		 <label for="slots">Song:</label>
			<select id="slots" name="slots">
			</select> 
		</div>
	</div>
	<div>
		<div class="input-group"><label for="title">Title:</label></div>
		<div class="input-group"><input type="text" id="title" name="title"></div>
		<label for="words" name="words">Lyrics:</label>
		<textarea id="words" rows="5"></textarea>
		<button onclick="save();" class="success">Save</button>
		<button onclick="load();" class="warning">Load</button>
	</div>
	<div>
	<span id="lindex">0/0</span>
	
	</div>
	<div class="input-group">
		<button onclick="sendLyricBack();" class="danger bigger">PREVIOUS</button>
		<button onclick="sendLyric();" class="primary bigger">ADVANCE</button>
	</div>

	<div class="input-group" style="margin-top: 30px;">
		<button onclick="mindcontrol.postMessage({'action':'hide'});" class="danger">Force Hide</button>
		<button onclick="mindcontrol.postMessage({'action':'show'});" class="primary">Force Show</button>
	</div>

	<button onclick="clearStorage();" class="danger" style="display:none;">CLEAR</button>
	

	</body>
	<script>
	loadSlots();

	function checkHotKeys(){
		if (hotkeyLyricSwitch1 != hotkeyLyricSwitch1Old){
			sendLyric();	
			hotkeyLyricSwitch1Old = hotkeyLyricSwitch1;
		}

		if (hotkeyLyricSwitch2 != hotkeyLyricSwitch2Old){
			sendLyricBack();	
			hotkeyLyricSwitch2Old = hotkeyLyricSwitch2;
		}

	}


	function updateHotkeys() {
		src = 'hotkeys.js';
		$('script[src="' + src + '"]').remove();
		var head= document.getElementsByTagName('head')[0];
		var script= document.createElement('script');
		script.src= src;
		head.appendChild(script);
	}


	function checkUpdates() {
		updateHotkeys();
		checkHotKeys();
	}

	setInterval(checkUpdates, 200);
	</script>


	
	</html>