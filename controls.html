<!DOCTYPE html>
<html lang="en">
	<head>
	<script type="text/javascript">
	const bcp = new BroadcastChannel('obs-lyrics');

	bcp.onmessage = function (ev) {
		("#lyric-panel").html(ev.data);
		
	}

	var lyrics = [];
	var index = -1;

	function ingest(){
		words = $("#words").val().split("\n");
		//alert(lyrics.length);
		index = -1

		lyrics = [$("#title").val()];
		
		for(let x=0; x<words.length; x+=2){
			lyrics.push(words[x] + "<br>" + words[x+1]);
		}

		//lyrics.splice(0,0, $("#title").val());
		$("#lindex").html(index + "/" + lyrics.length);
	}

	function save(){
		console.log($("#slots").val());
		localStorage.setItem($("#slots").val(), JSON.stringify({'title':$("#title").val(), 'lyrics':$("#words").val()}));
	}

	function load(){
		var x = $("#slots").val();
		var s = JSON.parse(localStorage.getItem(x));
		if(s){
				$("#title").val(s.title);
				$("#words").val(s.lyrics);
				ingest();
			}else{
				$("#title").val("");
				$("#words").val("");	
			}
	}

	function sendLyric(){
		if(index == -1){
			bcp.postMessage({'action':'update_title','text': lyrics[0]});
			bcp.postMessage({'action':'show'});
			index = 0;
			index++;
			$("#lindex").html(index + "/" + lyrics.length);
			return;
		}

		if(index >= lyrics.length){
			//time to hide!
			bcp.postMessage({'action':'hide'});
			return;
		}

		bcp.postMessage({'action':'update_title','text': lyrics[index]});
		index++;
		$("#lindex").html(index + "/" + lyrics.length);
	}

	function loadSlots(){
		//var opts = "";
		$("#slots").html("");
		for(let x = 1; x<11; x++){
			console.dir(localStorage.getItem("Song" + x));
			var s = JSON.parse(localStorage.getItem("Song" + x));
			if(s){
				$("#slots").append(new Option(s.title, "Song"+x));
			}else{
				$("#slots").append(new Option(x + " - Empty", "Song"+x));
			}
			
		}
	}

	function clearStorage(){
		localStorage.clear();
	}


	</script>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>Lyric Magic</title>
		<link rel="stylesheet" href="controlpanel.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	</head>
	<body>
	<div id="slotselect">
		 <label for="slots">Song:</label>
			<select id="slots" name="slots">
			</select> 
	</div>
	<div>
		<label for="title">Title:</label>
		<input type="text" id="title" name="title">
		<label for="words" name="words">Lyrics:</label>
		<textarea id="words" rows="5"></textarea>
		<button onclick="save();">Save</button>
		<button onclick="load();">Load</button>
	</div>
	<div>
	<span id="lindex">0/0</span>
	
	</div>
		
		
		
		
		
		<button onclick="sendLyric();">SEND</button>
	</div>

	<button onclick="clearStorage();">CLEAR</button>
	

	</body>
	<script>
	loadSlots();
	</script>


	
	</html>